language: node_js
node_js:
  - 'lts/*'
sudo: required
services:
  - docker

  jobs:
  include:
    -
      stage: test
      install: true
      script:
        - 'echo "mocha"'
    -
      stage: build
      install: true
      script:
        - 'echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin'
        - 'docker build -f Dockerfile -t tkurki/signalk-server:linux-amd64-"$BRANCH" .'
    -
      stage: build
      install: true
      script:
        - 'echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin'
        - 'docker run --rm --privileged multiarch/qemu-user-static:register --reset'
        - mkdir tmp
        - >
           pushd tmp &&
           curl -L -o qemu-arm-static.tar.gz https://github.com/multiarch/qemu-user-static/releases/download/v2.11.0/qemu-arm-static.tar.gz &&
           tar xzf qemu-arm-static.tar.gz &&
           popd        
        - 'docker build -f Dockerfile -t tkurki/signalk-server:linux-armhf-"$BRANCH" --build-arg IMAGE_BASE=arm32v7/node .'
    -
      stage: push
      if: branch = master OR tag = true
      install: true
      script:
        - 'echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin'
        # - export BRANCH=$(if [ "$TRAVIS_PULL_REQUEST" == "false" ]; then echo $TRAVIS_BRANCH; else echo $TRAVIS_PULL_REQUEST_BRANCH; fi)
        # - ./make-manifest.sh
        # - docker run --rm -v `pwd`:`pwd` -w `pwd` tkurki/manifest-tool --username="$DOCKER_USER" --password="$DOCKER_PASS" push from-spec docker-manifest.yml

